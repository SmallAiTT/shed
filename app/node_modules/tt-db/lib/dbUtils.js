var fs = require("fs");
var async = require("async");

/**
 * Desc: 条件获取的方法。
 * @author zheng.xiaojun
 *
 * @param cnd
 * @param args
 * @param cb
 * @returns {*}
 */
function getCnd(cnd, args, cb){
    if(arguments.length > 3) return null;
    if(arguments.length == 1){
        return {where : " where 1 = 1 ", args : [], cb : arguments[0]}
    }else if(arguments.length == 2){
        var info = {args : [], cb : args};
        args = cnd;
        cnd = " where 1 = 1 ";
        if(args){
            for (var key in args) {
                if(!key || key == "_orderBy" || typeof args[key] == "function") continue;
                cnd += " and " + key + " = ? ";
                info.args.push(args[key]);
            }
            var orderByArr = args._orderBy;
            if(orderByArr && orderByArr.length > 0){
                cnd += " order by "
                for (var i = 0, li = orderByArr.length; i < li; i++) {
                    cnd += " " + orderByArr[i] + " ";
                    if(i < li -1) cnd += ","
                }
            }
        }
        info.where = cnd;
        return info;
    }
    cnd = cnd || "";
    if(cnd.trim() != "" && cnd.search(/^[\s]*where[\s]/) != 0){
        cnd = " where " + cnd
    }
    return {where : cnd, args : args, cb : cb};
};
/**
 * Desc: 插入操作。
 * @author zheng.xiaojun
 *
 * @param poClass
 * @param args
 * @param cb
 */
function insert(poClass, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var sqlStr = "insert into " + tableName + " set ? ";
    this.query(sqlStr, args, cb);
};
/**
 * Desc: 更新操作。
 * @author zheng.xiaojun
 *
 * @param poClass
 * @param values
 * @param cnd
 * @param args
 * @param cb
 */
function update(poClass, values, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 2));
    var cols = "";
    var tempArr = [];
    if(typeof values == "string"){
        cols = values;
    }else{
        for (var key in values) {
            if(!key || typeof values[key] == "function") continue;
            cols += key + " = ?,"
            tempArr.push(values[key]);
        }
        cols = cols.substring(0, cols.length - 1);//去除最有一个逗号
    }

    var sqlStr = "update " + tableName + " set " + cols + cnd.where;
    this.query(sqlStr, tempArr.concat(cnd.args), cnd.cb);
};
/**
 * Desc: 获取单条数据操作。
 * @author zheng.xiaojun
 *
 * @param poClass
 * @param cnd
 * @param args
 * @param cb
 */
function select(poClass, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 1));
    var strSql = "select * from " + tableName + cnd.where +" limit 1";
    this.query(strSql, cnd.args, function (err, result) {
        err ? cnd.cb(err, null) : cnd.cb(null, result.length > 0 ? result[0] : null);
    });
};

/**
 * 根据条件计算数量
 * @param poClass
 * @param cnd
 * @param args
 * @param cb
 */
function count(poClass, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 1));
    var strSql = "select count(1) as count from " + tableName + cnd.where +" limit 1";
    this.query(strSql, cnd.args, function (err, result) {
        err ? cnd.cb(err, null) : cnd.cb(null, result.length > 0 ? result[0].count : 0);
    });
};

/**
 * Desc: 获取单条某些列数据操作。
 * @author mxs
 * @param poClass
 * @param cols
 * @param cnd
 * @param args
 * @param cb
 */
function selectCols(poClass,cols, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 2));
    var strCols = cols instanceof Array ? cols.join(",") : cols;
    var strSql = "select "+strCols+" from " + tableName + cnd.where +" limit 1";
    this.query(strSql, cnd.args, function (err, result) {
        err ? cnd.cb(err, null) : cnd.cb(null, result.length > 0 ? result[0] : null);
    });
};
/**
 * Desc: 删除操作。
 * @author zheng.xiaojun
 *
 * @param poClass
 * @param cnd
 * @param args
 * @param cb
 */
function del(poClass, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 1));
    var sql = "delete from " + tableName + cnd.where;
    this.query(sql, cnd.args || [], cnd.cb);
};
/**
 * Desc: 获取列表操作。
 * @author zheng.xiaojun
 *
 * @param poClass
 * @param cnd
 * @param args
 * @param cb
 */
function list(poClass, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 1));
    var strSql = "select * from	" + tableName + cnd.where;
    this.query(strSql, cnd.args, cnd.cb);
};

/**
 * Desc: 获取列表操作。
 * @author mxs
 * @param cols
 * @param poClass
 * @param cnd
 * @param args
 * @param cb
 */
function listCols(poClass,cols, cnd, args, cb){
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, Array.prototype.slice.call(arguments, 2));
    var strCols = cols instanceof Array ? cols.join(",") : cols;
    var strSql = "select "+strCols+" from " + tableName + cnd.where;
    this.query(strSql, cnd.args, cnd.cb);
};

function pageGridByReq(poClass, cnd, args, req, cndMap, cb){
    var self = this;
    var arr = Array.prototype.slice.apply(arguments);
    req = arr[arr.length - 3];
    cndMap = arr[arr.length - 2];
    cb = arr[arr.length - 1];
    arr.splice(arguments.length - 3, 2);
    var tableName = typeof poClass == "string" ? poClass : poClass.tableName;
    var cnd = getCnd.apply(this, arr.slice(1));
    console.log(cnd.where);
    var args = cnd.args;
    var where = cnd.where;
    var str = "";
    var body = req.body;
    for(var key in cndMap){
        var cndVal = cndMap[key];
        if(cndVal.indexOf("?")){
            if(body[key] != null){
                str += " and " + key + cndVal;
                args.push(body[key]);
            }
        }else{
            str += " and " + key + cndVal;
        }
    }
    var index = where.indexOf("order by")
    if(str != ""){
        if(index){
            where = where.substring(0, index) + str + " " + where.substring(index);
        }else{
            where += str;
        }
    }
    async.parallel([
        function(cb1){
            var strSql = "select count(1) total from " + tableName + where;
            self.query(strSql, args, function(err1, results){
                if(err1) return cb1(err1);
                cb1(null, results[0].total)
            });
        },
        function(cb1){
            var page = body.page;
            var rows = body.rows;
            var strSql = "select * from " + tableName + where + " limit " + (rows*(page - 1)) + "," + rows;
            self.query(strSql, args, function(err1, results){
                if(err1) return cb1(err1);
                cb1(null, results)
            });
        }
    ], function(err, results){
        if(err) return cb(err);
        var total = results[0], rows = results[1];
        cb(null, {total:total, rows : rows});
    })
};

function getCndByReq(req, cndMap, args){
    var str = "";
    var body = req.body;
    for(var key in cndMap){
        var cndVal = cndMap[key];
        if(cndVal.indexOf("?")){
            if(body[key] != null){
                str += " and " + key + cndVal;
                args.push(body[key]);
            }
        }else{
            str += " and " + key + cndVal;
        }
    }
    return str;
}
function pageGridSqlByReq(sql, args, req, cndMap, cb){
    var self = this;
    args = args || [];
    var cndStr = getCndByReq(req, cndMap, args);
    var where = " where 1 = 1 " + cndStr;
    sql = "select * from (" + sql + ") _1 where 1 = 1 " + cndStr;
    async.parallel([
        function(cb1){
            var strSql = "select count(1) total from (" + sql + ") _2 " + where;
            self.query(strSql, args, function(err1, results){
                if(err1) return cb1(err1);
                cb1(null, results[0].total)
            });
        },
        function(cb1){
            var page = req.body.page;
            var rows = req.body.rows;
            var strSql = "select * from (" + sql + ") _2 " + where + " limit " + (rows*(page - 1)) + "," + rows;
            self.query(strSql, args, function(err1, results){
                if(err1) return cb1(err1);
                cb1(null, results)
            });
        }
    ], function(err, results){
        if(err) return cb(err);
        var total = results[0], rows = results[1];
        cb(null, {total:total, rows : rows});
    })
}
var sqlPool = {};
var REG_SUB = /@SUB_START(([\s][\w\W]*[\s])|([\s]))@SUB_END/gi;
function getSql(filePath){
    var sql = sqlPool[filePath];
    if(sql) return sql;
    var sql = fs.readFileSync(filePath).toString();
    var subContent = REG_SUB.exec(sql);
    if(subContent){
        subContent = subContent[0].substring(10, subContent[0].length - 8).trim();
        sql = sql.replace(REG_SUB, "");
        var arr = subContent.split("\n");
        for (var i = 0, li = arr.length; i < li; i++) {
            var itemi = arr[i].trim();
            if(itemi == "") continue;
            var index = itemi.indexOf("=");
            if(index < 0) throw "SUB for sql error!";
            var key = itemi.substring(0, index).trim();
            var value = itemi.substring(index + 1).trim();
            var regExp = new RegExp("\\[\\%" + key + "\\%\\]", "gi");
            sql = sql.replace(regExp, value);
        }
    }
    sqlPool[filePath] = sql;
    return sql;
};
/**
 * Desc: 通过sqlCode进行操作。
 * @param code
 * @param args
 * @param cb
 */
function queryByCode(code, args, cb){
    var sql = getSql(code);
    this.query(sql, args, cb);
}

/**
 * Desc: 为对象初始化基础的数据库操作功能。
 * @author zheng.xiaojun
 *
 * @param target
 */
function initDbOper(target){
    target.insert = target.insert ? target.insert : insert;
    target.update = target.update ? target.update : update;
    target.select = target.select ? target.select : select;
    target.del = target.del ? target.del : del;
    target.list = target.list ? target.list : list;

    target.selectCols = target.selectCols ? target.selectCols : selectCols;
    target.listCols = target.listCols ? target.listCols : listCols;
    target.queryByCode = target.queryByCode ? target.queryByCode : queryByCode;

    target.pageGridByReq = target.pageGridByReq ? target.pageGridByReq : pageGridByReq;
    target.pageGridSqlByReq = target.pageGridSqlByReq ? target.pageGridSqlByReq : pageGridSqlByReq;
}

exports.getCnd = getCnd;
exports.initDbOper = initDbOper;