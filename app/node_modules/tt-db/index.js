var dbPool = require("./lib/dbPool");
var DbClient = require("./lib/DbClient");
var BaseDao = require("./lib/BaseDao");
var Trans = require("./lib/Trans");
var ttCfg = require("tt-cfg");
var dbCfg = ttCfg.dbCfg;

exports.dbCfg = dbCfg;
exports.dbPool = dbPool;
exports.DbClient = DbClient;
exports.BaseDao = BaseDao;
exports.Trans = Trans;

var pool = dbPool.create(dbCfg.cnn);
var client = new DbClient(pool);
var trans = new Trans(pool);

exports.embed = function(app){
    app.use(function(req, res, next){
        req.dbClient = client;
        req.startTrans = function(cb){
            req.dbClient = trans;
        }
        next();
    });

    app.pushErrHandler(function(err, req, res, next){
        var dbClient = res.dbClient;
        dbClient && dbClient.rollback && dbClient.rollback();
        next(err);
    });

    app.use("/", require("./test/clientTest.js"));

}