var async = require("async");
var PvlDs = require("../ds/PvlDs.js");
var MenuNodeDs = require("../ds/MenuNodeDs.js");
var pvlDs;

module.exports = function(req, res, next){
    res._oldRender = res.render;
    res.render = function(url, args){
        var renderArgs = this.renderArgs;
        if(args) {
            for (var key in args) {
                renderArgs[key] = args[key];
            }
        }
        this._oldRender(url, renderArgs);
    }

    var client = req.dbClient;
    if(pvlDs) {
        req.pvlDs = pvlDs;
        res.renderArgs = {
            pvlDs : pvlDs
        };
        return next();
    }
    pvlDs = new PvlDs();
    req.pvlDs = pvlDs;
    res.renderArgs = {
        pvlDs : pvlDs
    }
    client.list("tt_pvl", "code like 'shed%' order by code", [], function(err, list){
        if(err) return next(err);
        var tempMap = {};
        for(var i = 0; i < list.length; ++i){
            var data = list[i];
            pvlDs.pvlMap[data.code] = data;
            if(data.url) pvlDs.urlMap[data.url] = data;
            if(data.type == "menu"){
                var menuNode = new MenuNodeDs(data.code, data.name, data.url);
                tempMap[data.code] = menuNode;
                if(!data.parent){
                    pvlDs.menus.push(menuNode);//放到菜单列表中
                }else{
                    var parentNode = tempMap[data.parent];
                    if(parentNode) parentNode.children.push(menuNode);//放入节点中
                }
            }
            console.log(pvlDs);
        }
        next();
    });
};