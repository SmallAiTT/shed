var async = require("async");
var PvlDs = require("../ds/PvlDs.js");
var MenuNodeDs = require("../ds/MenuNodeDs.js");

module.exports = function(req, res, next){
    var client = req.dbClient;
    var pvlDs = new PvlDs();
    req.pvlDs = pvlDs;
    res.renderArgs = {
        pvlDs : pvlDs
    }
    client.list("tt_pvl", {_orderBy : ["code"]}, function(err, list){
        if(err) return next(err);
        var tempMap = {};
        for(var i = 0; i < list.length; ++i){
            var data = list[i];
            pvlDs.pvlMap[data.code] = data;
            if(data.url) pvlDs.urlMap[data.url] = data;
            if(data.type == "menu"){
                var menuNode = new MenuNodeDs(data.code, data.name, data.url);
                tempMap[data.code] = menuNode;
                if(!data.parent){
                    pvlDs.menus.push(menuNode);//放到菜单列表中
                }else{
                    var parentNode = tempMap[data.parent];
                    if(parentNode) parentNode.children.push(menuNode);//放入节点中
                }
            }
        }

        res._oldRender = res.render;
        res.render = function(url, args){
            var renderArgs = this.renderArgs;
            if(args) {
                for (var key in args) {
                    renderArgs[key] = args[key];
                }
            }
            this._oldRender(url, renderArgs);
        }
        next();
    });
//    async.parallel([
//        function(cb){//menu
//            doMenu(client, pvlDs, cb);
//        },
//        function(cb){
//            doBtn(client, pvlDs, cb);
//        }
//    ], function(err){
//        if(err) return next(err);
////        console.log("====>", pvlDs.btnPvlMap);
//        next();
//    });
};