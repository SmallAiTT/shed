var domain = require("domain")
exports.embed = function(app, func){
    app._errHandlers = [];
    app.pushErrHandler = function(handler){
        app._errHandlers.push(handler);
    };
    app.use(function(req, res, next){
        //异常处理
        var d = domain.create();
        d.on("error", function(err){
            next(err);
        });
        d.add(req);
        d.add(res);
        d.run(function(){
            next();
        });
    });

    func();

    for(var i = app._errHandlers.length - 1; i >= 0; --i){
        app.use(app._errHandlers[i]);
    }

    app.use(function(err, req, res, next){
        console.error(err.stack || err);
        //判断是不是ajax请求
        return next(err.message || err.msg || err);
        if(req.xhr){//是ajax请求
            next(err.msg || err);
        }else{
            res.send(404);
        }
    });
}