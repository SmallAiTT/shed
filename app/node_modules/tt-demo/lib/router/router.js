var fs = require("fs");
var path = require("path");
var express = require("express");
var expressCfg = require("tt-cfg").expressCfg;
var demoDir = path.join(expressCfg.setOpt.views, "demo");


var router = module.exports = express.Router();


function workDir(viewsDir, dir){
    var files = fs.readdirSync(dir);
    for(var i = 0, li = files.length; i < li; ++i){
        var file = files[i]
        var filePath = path.join(dir, file);
        if(fs.statSync(filePath).isDirectory()){
            workDir(viewsDir, filePath);
        }else{
            var extname = path.extname(filePath);
            if(extname && extname.toLowerCase() == ".html"){
                var str = path.basename(file, extname);
                str = path.join(dir, str);
                str = path.relative(viewsDir, str);
                str = str.replace(/\\/g, "/");
                initRoute(str);
            }
        }
    }
}

var initRoute = function(url){
    console.log(url);
    router.get("/" + url, function(req, res){
        res.render(url, {
            title: "EJS example",
            header: "Some users",
            pvlDs : req.pvlDs
        });
    });
}
workDir(expressCfg.setOpt.views, demoDir);
